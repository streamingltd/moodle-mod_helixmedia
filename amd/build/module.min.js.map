{"version":3,"file":"module.min.js","sources":["../src/module.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @package\n * @copyright  2021 Tim Williams Streaming LTD\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n    var module = {};\n    module.instances = [];\n    module.first = true;\n\n    module.medialinstance = function($, params) {\n\n        var minst = {};\n        minst.params = params;\n        minst.params.gotIn = false;\n        minst.params.medialinterval = false;\n\n        minst.openmodal = function(evt) {\n            evt.preventDefault();\n            $('#mod_helixmedia_launchframe_' + minst.params.docID).attr('src', minst.params.launchurl);\n            $('.modal-backdrop').css('position', 'relative');\n            $('.modal-backdrop').css('z-index', '0');\n\n            if (minst.params.doStatusCheck) {\n                setTimeout(minst.checkStatus, 5000);\n                setTimeout(minst.maintainSession, minst.params.sessionFreq);\n            }\n        };\n\n        minst.closemodalListen = function(evt) {\n            evt.preventDefault();\n            minst.closemodal();\n        };\n\n        minst.closemodal = function() {\n            if (minst.params.medialinterval != false) {\n                clearInterval(minst.params.medialinterval);\n            }\n\n            $('#mod_helixmedia_launchframe_' + minst.params.docID).attr('src', '');\n\n            if (!minst.params.doStatusCheck) {\n                return;\n            }\n\n            var tframe = document.getElementById(\"mod_helixmedia_thumbframe_\" + minst.params.docID);\n            if (tframe !== null && typeof (minst.params.thumburl) != \"undefined\") {\n                tframe.contentWindow.location = minst.params.thumburl;\n            }\n\n            var mform1 = document.getElementById(\"mform1\");\n            if (mform1 === null) {\n                var elements = document.getElementsByClassName(\"mform\");\n                mform1 = elements[0];\n            }\n\n        };\n\n        minst.closeDialogue = function() {\n            $('#mod_helixmedia_modal_' + minst.params.docID).modal('hide');\n            minst.closemodal();\n        };\n\n        minst.bind = function() {\n            $('#helixmedia_ltimodal_' + minst.params.docID).click(minst.openmodal);\n            $('#mod_helixmedia_closemodal_' + minst.params.docID).click(minst.closemodalListen);\n        };\n\n        minst.unbind = function() {\n            $('#helixmedia_ltimodal_' + minst.params.docID).off();\n            $('#mod_helixmedia_closemodal_' + minst.params.docID).off();\n            if (minst.params.medialinterval != false) {\n                clearInterval(minst.params.medialinterval);\n            }\n        };\n\n        minst.maintainSession = function() {\n            var xmlDoc = new XMLHttpRequest();\n            xmlDoc.open(\"GET\", minst.params.sessionURL, true);\n            xmlDoc.send();\n            setTimeout(minst.maintainSession, minst.params.sessionFreq);\n        };\n\n        minst.checkStatusResponse = function(evt) {\n            var responseText = evt.target.responseText;\n            if (responseText == \"IN\") {\n                minst.params.gotIn = true;\n            }\n            if (responseText != \"OUT\" || minst.params.gotIn == false) {\n                if (minst.params.medialinterval == false) {\n                    minst.params.medialinterval = setInterval(minst.checkStatus, 2000);\n                }\n            } else {\n\n                if (minst.params.resDelay == 0) {\n                    minst.closeDialogue();\n                } else {\n                    setTimeout(minst.closeDialogue, (minst.params.resDelay * 1000));\n                }\n            }\n        };\n\n        minst.checkStatus = function() {\n            var xmlDoc = new XMLHttpRequest();\n            var params = \"resource_link_id=\" + minst.params.resID +\n                \"&user_id=\" + minst.params.userID + \"&oauth_consumer_key=\" + minst.params.oauthConsumerKey;\n            xmlDoc.addEventListener(\"load\", minst.checkStatusResponse);\n            xmlDoc.open(\"POST\", minst.params.statusURL);\n            xmlDoc.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n            xmlDoc.send(params);\n        };\n\n        return minst;\n    };\n\n    module.init = function(frameid, launchurl, thumburl, resID, userID, statusURL, oauthConsumerKey, doStatusCheck,\n        sessionURL, sessionFreq, resDelay, extraID) {\n\n        // AMD Modules aren't unique, so this will get called in the same instance for each MEDIAL we have on the page.\n        // That causes trouble on the quiz grading interface in particular, so wrap each call in an inner object.\n\n        // Sanity check, sometimes this gets called more than once with the same resID. Clean up the old one and re-init.\n        if (typeof module.instances[resID + extraID] !== 'undefined') {\n            module.instances[resID + extraID].unbind();\n        }\n\n        var params = {};\n        params.frameid = frameid;\n        params.launchurl = launchurl;\n        params.thumburl = thumburl;\n        params.resID = resID;\n        params.userID = userID;\n        params.statusURL = statusURL;\n        params.oauthConsumerKey = oauthConsumerKey;\n        params.doStatusCheck = doStatusCheck;\n        params.sessionURL = sessionURL;\n        params.sessionFreq = sessionFreq;\n        params.resDelay = resDelay;\n        params.docID = resID + extraID;\n        var medialhandler = module.medialinstance($, params);\n        module.instances[params.docID] = medialhandler;\n        medialhandler.bind();\n    };\n\n    return module;\n});\n"],"names":["define","$","module","params","minst","gotIn","medialinterval","openmodal","evt","preventDefault","docID","attr","launchurl","css","doStatusCheck","setTimeout","checkStatus","maintainSession","sessionFreq","closemodalListen","closemodal","clearInterval","tframe","document","getElementById","thumburl","contentWindow","location","mform1","getElementsByClassName","closeDialogue","modal","bind","click","unbind","off","xmlDoc","XMLHttpRequest","open","sessionURL","send","checkStatusResponse","responseText","target","setInterval","resDelay","resID","userID","oauthConsumerKey","addEventListener","statusURL","setRequestHeader","frameid","extraID","instances","medialhandler","medialinstance"],"mappings":"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"}