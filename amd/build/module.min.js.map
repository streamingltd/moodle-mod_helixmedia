{"version":3,"file":"module.min.js","sources":["../src/module.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @package\n * @copyright  2021 Tim Williams Streaming LTD\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n    var module = {};\n    module.instances = [];\n    module.first = true;\n\n    module.medialinstance = function($, params) {\n\n        var minst = {};\n        minst.params = params;\n        minst.params.gotIn = false;\n        minst.params.medialInterval = false;\n\n        minst.openmodal = function(evt) {\n            evt.preventDefault();\n            $('#mod_helixmedia_launchframe_' + minst.params.docID).attr('src', minst.params.launchurl);\n            if (!minst.params.bs5) {\n                $('.modal-backdrop').css('position', 'relative');\n            }\n            $('.modal-backdrop').css('z-index', '0');\n\n            if (minst.params.doStatusCheck) {\n                setTimeout(minst.checkStatus, 5000);\n                setTimeout(minst.maintainSession, minst.params.sessionFreq);\n            }\n        };\n\n        minst.textfit = function($) {\n            $('.helixmedia_fittext').each(function() {\n                var w2 = $(this).width();\n                if ($(this).text().length > 16 && w2 < 240) {\n                    var ratio = w2 / 240;\n                    $(this).css('font-size', ratio + 'em');\n                } else {\n                    $(this).css('font-size', 'large');\n                }\n            });\n        };\n\n        minst.closemodalListen = function(evt) {\n            evt.preventDefault();\n            minst.closemodal();\n        };\n\n        minst.closemodal = function() {\n            if (minst.params.medialInterval != false) {\n                clearInterval(minst.params.medialInterval);\n            }\n\n            $('#mod_helixmedia_launchframe_' + minst.params.docID).attr('src', '');\n\n            if (!minst.params.doStatusCheck) {\n                return;\n            }\n\n            var tframe = document.getElementById(\"mod_helixmedia_thumbframe_\" + minst.params.docID);\n            if (tframe !== null && typeof (minst.params.thumburl) !== \"undefined\") {\n                tframe.contentWindow.location = minst.params.thumburl;\n            }\n\n            var mform1 = document.getElementById(\"mform1\");\n            if (mform1 === null) {\n                var elements = document.getElementsByClassName(\"mform\");\n                mform1 = elements[0];\n            }\n\n        };\n\n        minst.closeDialogue = function() {\n            $('#mod_helixmedia_modal_' + minst.params.docID).modal('hide');\n            minst.closemodal();\n        };\n\n        minst.bind = function() {\n            $('#helixmedia_ltimodal_' + minst.params.docID).click(minst.openmodal);\n            $('#mod_helixmedia_closemodal_' + minst.params.docID).click(minst.closemodalListen);\n\n            minst.textfit($);\n        };\n\n        minst.unbind = function() {\n            $('#helixmedia_ltimodal_' + minst.params.docID).off();\n            $('#mod_helixmedia_closemodal_' + minst.params.docID).off();\n            if (minst.params.medialInterval != false) {\n                clearInterval(minst.params.medialInterval);\n            }\n        };\n\n        minst.maintainSession = function() {\n            var xmlDoc = new XMLHttpRequest();\n            xmlDoc.open(\"GET\", minst.params.sessionURL, true);\n            xmlDoc.send();\n            setTimeout(minst.maintainSession, minst.params.sessionFreq);\n        };\n\n        minst.checkStatusResponse = function(evt) {\n            var responseText = evt.target.responseText;\n            if (responseText == \"IN\") {\n                minst.params.gotIn = true;\n            }\n            if (responseText != \"OUT\" || minst.params.gotIn == false) {\n                if (minst.params.medialInterval == false) {\n                    minst.params.medialInterval = setInterval(minst.checkStatus, 2000);\n                }\n            } else {\n\n                if (minst.params.resDelay == 0) {\n                    minst.closeDialogue();\n                } else {\n                    setTimeout(minst.closeDialogue, (minst.params.resDelay * 1000));\n                }\n            }\n        };\n\n        minst.checkStatus = function() {\n            var xmlDoc = new XMLHttpRequest();\n            var params = \"resource_link_id=\" + minst.params.resID + \"&user_id=\" + minst.params.userID +\n                \"&oauth_consumer_key=\" + minst.params.oauthConsumerKey;\n            xmlDoc.addEventListener(\"load\", minst.checkStatusResponse);\n            xmlDoc.open(\"POST\", minst.params.statusURL);\n            xmlDoc.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n            xmlDoc.send(params);\n        };\n\n        return minst;\n    };\n\n    module.init = function(frameid, launchurl, thumburl, resID, userID, statusURL, oauthConsumerKey, doStatusCheck,\n        sessionURL, sessionFreq, resDelay, extraID, title, library, bs5) {\n\n        // AMD Modules aren't unique, so this will get called in the same instance for each MEDIAL we have on the page.\n        // That causes trouble on the quiz grading interface in particular, so wrap each call in an inner object.\n\n        // Sanity check, sometimes this gets called more than once with the same resID. Clean up the old one and re-init.\n        if (typeof module.instances[resID + extraID] !== 'undefined') {\n            module.instances[resID + extraID].unbind();\n        }\n\n        var params = {};\n        params.frameid = frameid;\n        params.launchurl = launchurl;\n        params.thumburl = thumburl;\n        params.resID = resID;\n        params.userID = userID;\n        params.statusURL = statusURL;\n        params.oauthConsumerKey = oauthConsumerKey;\n        params.doStatusCheck = doStatusCheck;\n        params.sessionURL = sessionURL;\n        params.sessionFreq = sessionFreq;\n        params.resDelay = resDelay;\n        params.docID = resID + extraID;\n        params.bs5 = bs5;\n\n        var medialhandler = module.medialinstance($, params);\n        module.instances[params.docID] = medialhandler;\n        medialhandler.bind();\n    };\n\n    return module;\n});\n"],"names":["define","$","module","params","minst","gotIn","medialInterval","openmodal","evt","preventDefault","docID","attr","launchurl","bs5","css","doStatusCheck","setTimeout","checkStatus","maintainSession","sessionFreq","textfit","each","w2","this","width","text","length","ratio","closemodalListen","closemodal","clearInterval","tframe","document","getElementById","thumburl","contentWindow","location","mform1","getElementsByClassName","closeDialogue","modal","bind","click","unbind","off","xmlDoc","XMLHttpRequest","open","sessionURL","send","checkStatusResponse","responseText","target","setInterval","resDelay","resID","userID","oauthConsumerKey","addEventListener","statusURL","setRequestHeader","frameid","extraID","title","library","instances","medialhandler","medialinstance"],"mappings":"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"}