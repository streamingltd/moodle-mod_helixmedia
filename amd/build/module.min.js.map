{"version":3,"file":"module.min.js","sources":["../src/module.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @package\n * @copyright  2021 Tim Williams Streaming LTD\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n    var module = {};\n    module.instances = [];\n    module.first = true;\n\n    module.medialinstance = function($, params) {\n\n        var minst = {};\n        minst.params = params;\n        minst.params.gotIn = false;\n\n        minst.params.medialInterval = false;\n        minst.params.videoref = '';\n\n        minst.openmodal = function(evt) {\n            evt.preventDefault();\n\n            var lu = minst.params.launchurl;\n            if (minst.params.videorref !== '') {\n                lu = lu + \"&video_ref=\" + minst.params.videoref;\n            }\n            $('#mod_helixmedia_launchframe_' + minst.params.docID).attr('src', lu);\n            if (!minst.params.bs5) {\n                $('.modal-backdrop').css('position', 'relative');\n            }\n\n            $('.modal-backdrop').css('z-index', '0');\n            if (minst.params.doStatusCheck) {\n                if (minst.params.statusURL !== false) {\n                    setTimeout(minst.checkStatus, 500);\n                }\n                setTimeout(minst.maintainSession, minst.params.sessionFreq);\n            }\n            window.addEventListener(\"message\", minst.onmessage);\n        };\n\n        minst.onmessage = function(evt) {\n            if (evt.origin != minst.params.origin) {\n                /* eslint-disable-next-line no-console */\n                console.log(\"Message rejected: bad origin evt: \" + evt.origin + \" expected: \" + minst.params.origin);\n                return;\n            }\n\n            var mform1 = document.getElementById(\"mform1\");\n            if (mform1 === null) {\n                var elements = document.getElementsByClassName(\"mform\");\n                mform1 = elements.item(0);\n            }\n\n            var name = mform1.elements.namedItem('name');\n            if (name !== null && name.value.length == 0) {\n                mform1.name.value = evt.data.title;\n            }\n\n            var custom = mform1.elements.namedItem('custom');\n            if (custom !== null) {\n                custom.value = JSON.stringify(evt.data.custom);\n            }\n\n            var hacustom = mform1.elements.namedItem('helixassign_custom');\n            if (hacustom !== null) {\n                hacustom.value = JSON.stringify(evt.data.custom);\n            }\n\n            var hfcustom = mform1.elements.namedItem('helixfeedback_custom');\n            if (hfcustom !== null) {\n                hfcustom.value = JSON.stringify(evt.data.custom);\n            }\n\n\n            var addgrades = mform1.elements.namedItem('addgrades');\n            if (addgrades !== null) {\n                if (evt.data.custom.is_quiz.toLowerCase() == \"true\") {\n                    addgrades.checked = true;\n                } else {\n                    addgrades.checked = false;\n                }\n            }\n\n            minst.params.videoref = evt.data.custom.video_ref;\n            setTimeout(minst.closeDialogue, 2000);\n        };\n\n        minst.textfit = function($) {\n            $('.helixmedia_fittext').each(function() {\n                var w2 = $(this).width();\n                if ($(this).text().length > 16 && w2 < 240) {\n                    var ratio = w2 / 240;\n                    $(this).css('font-size', ratio + 'em');\n                } else {\n                    $(this).css('font-size', 'large');\n                }\n            });\n        };\n\n        minst.closemodalListen = function(evt) {\n            evt.preventDefault();\n            minst.closemodal();\n        };\n\n        minst.closemodal = function() {\n            if (minst.params.medialInterval != false) {\n                clearInterval(minst.params.medialInterval);\n                minst.params.medialInterval = false;\n            }\n\n            $('#mod_helixmedia_launchframe_' + minst.params.docID).attr('src', '');\n\n            if (!minst.params.doStatusCheck) {\n                return;\n            }\n\n            var tframe = document.getElementById(\"mod_helixmedia_thumbframe_\" + minst.params.docID);\n\n            if (tframe !== null && typeof (minst.params.thumburl) != \"undefined\") {\n                if (minst.params.videorref === '') {\n                    tframe.contentWindow.location = minst.params.thumburl;\n                } else {\n                    tframe.contentWindow.location = minst.params.thumburl + \"&video_ref=\" + minst.params.videoref;\n                }\n\n            }\n        };\n\n        minst.closeDialogue = function() {\n            $('#mod_helixmedia_modal_' + minst.params.docID).modal('hide');\n            minst.closemodal();\n        };\n\n        minst.bind = function() {\n            $('#helixmedia_ltimodal_' + minst.params.docID).click(minst.openmodal);\n            $('#mod_helixmedia_closemodal_' + minst.params.docID).click(minst.closemodalListen);\n\n            minst.textfit($);\n        };\n\n        minst.unbind = function() {\n            $('#helixmedia_ltimodal_' + minst.params.docID).off();\n            $('#mod_helixmedia_closemodal_' + minst.params.docID).off();\n            if (minst.params.medialInterval != false) {\n                clearInterval(minst.params.medialInterval);\n                minst.params.medialInterval = false;\n            }\n        };\n\n        minst.maintainSession = function() {\n            var xmlDoc = new XMLHttpRequest();\n            xmlDoc.open(\"GET\", minst.params.sessionURL, true);\n            xmlDoc.send();\n            setTimeout(minst.maintainSession, minst.params.sessionFreq);\n        };\n\n        minst.checkStatusResponse = function(evt) {\n            var responseText = evt.target.responseText;\n            if (responseText == \"IN\") {\n                minst.params.gotIn = true;\n            }\n            if (responseText != \"OUT\" || minst.params.gotIn == false) {\n\n                if (minst.params.medialInterval == false) {\n                    minst.params.medialInterval = setInterval(minst.checkStatus, 2000);\n                }\n            } else {\n                if (minst.params.resDelay == 0) {\n                    minst.closeDialogue();\n                } else {\n                    setTimeout(minst.closeDialogue, (minst.params.resDelay * 1000));\n                }\n            }\n        };\n\n        minst.checkStatus = function() {\n            var xmlDoc = new XMLHttpRequest();\n            var params = \"resource_link_id=\" + minst.params.resID + \"&user_id=\" + minst.params.userID +\n                \"&oauth_consumer_key=\" + minst.params.oauthConsumerKey;\n            xmlDoc.addEventListener(\"load\", minst.checkStatusResponse);\n            xmlDoc.open(\"POST\", minst.params.statusURL);\n            xmlDoc.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n            xmlDoc.send(params);\n        };\n\n        return minst;\n    };\n\n    module.init = function(frameid, launchurl, thumburl, resID, userID, statusURL, oauthConsumerKey, doStatusCheck,\n        sessionURL, sessionFreq, resDelay, extraID, title, library, origin, bs5) {\n\n\n        // AMD Modules aren't unique, so this will get called in the same instance for each MEDIAL we have on the page.\n        // That causes trouble on the quiz grading interface in particular, so wrap each call in an inner object.\n\n        // Sanity check, sometimes this gets called more than once with the same resID. Clean up the old one and re-init.\n        if (typeof module.instances[resID + extraID] !== 'undefined') {\n            module.instances[resID + extraID].unbind();\n        }\n\n        var params = {};\n        params.frameid = frameid;\n        params.launchurl = launchurl;\n        params.thumburl = thumburl;\n        params.resID = resID;\n        params.userID = userID;\n        params.statusURL = statusURL;\n        params.oauthConsumerKey = oauthConsumerKey;\n        params.doStatusCheck = doStatusCheck;\n        params.sessionURL = sessionURL;\n        params.sessionFreq = sessionFreq;\n        params.resDelay = resDelay;\n        params.docID = resID + extraID;\n        params.bs5 = bs5;\n        params.origin = origin;\n        var medialhandler = module.medialinstance($, params);\n        module.instances[params.docID] = medialhandler;\n        medialhandler.bind();\n    };\n\n    return module;\n});\n"],"names":["define","$","module","params","minst","gotIn","medialInterval","videoref","openmodal","evt","preventDefault","lu","launchurl","videorref","docID","attr","bs5","css","doStatusCheck","statusURL","setTimeout","checkStatus","maintainSession","sessionFreq","window","addEventListener","onmessage","origin","mform1","document","getElementById","getElementsByClassName","item","name","elements","namedItem","value","length","data","title","custom","JSON","stringify","hacustom","hfcustom","addgrades","is_quiz","toLowerCase","checked","video_ref","closeDialogue","console","log","textfit","each","w2","this","width","text","ratio","closemodalListen","closemodal","clearInterval","tframe","thumburl","contentWindow","location","modal","bind","click","unbind","off","xmlDoc","XMLHttpRequest","open","sessionURL","send","checkStatusResponse","responseText","target","setInterval","resDelay","resID","userID","oauthConsumerKey","setRequestHeader","frameid","extraID","library","instances","medialhandler","medialinstance"],"mappings":"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"}